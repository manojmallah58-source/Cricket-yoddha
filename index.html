<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>Advanced Pro Player</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>

    <style>
        :root {
            --plyr-color-main: #ffb400; /* Screenshot Yellow */
            --plyr-video-background: #000;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: #000;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        /* Loading Screen Fix */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            transition: opacity 0.5s ease;
        }

        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #333;
            border-top: 5px solid #ffb400;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .player-container {
            width: 100%; height: 100%;
            display: flex; align-items: center;
            opacity: 0; /* Starting mein hidden rahega */
            transition: opacity 0.5s ease;
        }

        .plyr__controls {
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.9)) !important;
            padding: 25px 15px 15px !important;
        }

        video { object-fit: contain; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="player-container" id="main-player">
        <video id="player" playsinline crossorigin="anonymous"></video>
    </div>

<script>
    const video = document.getElementById('player');
    const loading = document.getElementById('loading-overlay');
    const playerDiv = document.getElementById('main-player');
    const source = new URLSearchParams(window.location.search).get('url');

    const controls = [
        'play-large', 'play', 'progress', 'current-time', 
        'duration', 'mute', 'volume', 'settings', 'fullscreen'
    ];

    function showPlayer() {
        loading.style.opacity = '0';
        setTimeout(() => {
            loading.style.display = 'none';
            playerDiv.style.opacity = '1';
        }, 500);
    }

    if (Hls.isSupported() && source) {
        const hls = new Hls();
        hls.loadSource(source);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function () {
            const qualities = hls.levels.map(l => l.height);
            qualities.unshift(0); 

            const player = new Plyr(video, {
                controls,
                quality: {
                    default: 0,
                    options: qualities,
                    forced: true,
                    onChange: (q) => {
                        if (q === 0) hls.currentLevel = -1;
                        else hls.levels.forEach((l, i) => { if (l.height === q) hls.currentLevel = i; });
                    }
                }
            });

            // Camera Button
            addCamBtn();
            
            // Jab video ready ho jaye tabhi dikhao
            player.on('ready', showPlayer);
        });
    } else {
        video.src = source;
        const player = new Plyr(video, { controls });
        player.on('ready', showPlayer);
    }

    function addCamBtn() {
        const bar = document.querySelector('.plyr__controls');
        if (!bar) return;
        const btn = document.createElement('button');
        btn.className = 'plyr__control';
        btn.innerHTML = `<svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>`;
        btn.onclick = () => {
            const c = document.createElement('canvas');
            c.width = video.videoWidth; c.height = video.videoHeight;
            c.getContext('2d').drawImage(video, 0, 0);
            const a = document.createElement('a');
            a.download = 'Screenshot.png'; a.href = c.toDataURL(); a.click();
        };
        bar.insertBefore(btn, bar.querySelector('[data-plyr="settings"]'));
    }
</script>

</body>
</html>
