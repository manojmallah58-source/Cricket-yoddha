<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="referrer" content="no-referrer">
    <title>Cricket Yoddha | High Quality</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.js"></script>

    <style>
        :root { --plyr-color-main: #ff0000; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }

        #video-container { width: 100%; max-width: 1000px; }
        
        /* Modern Player UI */
        .plyr { aspect-ratio: 16/9; background: #000; }
        
        /* Screenshot Button UI */
        .plyr__control--screenshot svg { width: 20px !important; height: 20px !important; stroke: white; }
        
        video { opacity: 0; transition: opacity 0.5s ease; }
        video.ready { opacity: 1; }

        canvas { display: none; }
    </style>
</head>
<body>

<div id="video-container">
    <video id="player" playsinline controls crossorigin="anonymous"></video>
</div>

<canvas id="screenshot-canvas"></canvas>

<script>
    const video = document.getElementById('player');
    const canvas = document.getElementById('screenshot-canvas');
    const urlParam = new URLSearchParams(window.location.search).get('url');

    if (urlParam) {
        if (Hls.isSupported()) {
            const hls = new Hls({
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 90
            });
            hls.loadSource(urlParam);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
                // Quality Levels ko automatic fetch karna
                const availableQualities = data.levels.map(l => l.height);
                initPlayer(availableQualities, hls);
                video.classList.add('ready');
            });
        } else {
            video.src = urlParam;
            video.classList.add('ready');
            initPlayer();
        }
    }

    function initPlayer(qualities = [], hlsInstance = null) {
        const player = new Plyr(video, {
            autoplay: true,
            settings: ['quality', 'speed'],
            quality: {
                default: qualities[0] || 720,
                options: qualities,
                forced: true,
                onChange: (newQuality) => {
                    if (hlsInstance) {
                        hlsInstance.levels.forEach((level, levelIndex) => {
                            if (level.height === newQuality) {
                                hlsInstance.currentLevel = levelIndex;
                            }
                        });
                    }
                }
            },
            controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen']
        });

        // Screenshot Button Injection
        player.on('ready', () => {
            const settingsBtn = document.querySelector('[data-plyr="settings"]');
            if (settingsBtn && !document.querySelector('.plyr__control--screenshot')) {
                const ssBtn = document.createElement('button');
                ssBtn.type = 'button';
                ssBtn.className = 'plyr__control plyr__control--screenshot';
                ssBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>`;
                
                settingsBtn.before(ssBtn);

                ssBtn.onclick = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    try {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = canvas.toDataURL('image/png');
                        
                        // Gallery mein save karne ke liye direct download trigger
                        const downloadLink = document.createElement('a');
                        downloadLink.download = `CricketYoddha_Live_${Date.now()}.png`;
                        downloadLink.href = imageData;
                        downloadLink.click();
                    } catch(e) { 
                        alert("Note: Quality change settings and Screenshot depends on your m3u8 link's CORS policy."); 
                    }
                };
            }
        });
    }

    // Auto-Landscape Mode
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement && screen.orientation) {
            screen.orientation.lock('landscape').catch(() => {});
        } else {
            if (screen.orientation.unlock) screen.orientation.unlock();
        }
    });
</script>

</body>
</html>
